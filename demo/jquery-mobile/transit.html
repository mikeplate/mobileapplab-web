<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1"> 
        <title>SweTransit App</title>
        <link href="http://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
        <link href="http://fonts.googleapis.com/css?family=Ubuntu+Condensed" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css">
        <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
        <style>
        </style>
    </head>
    <body>
        <div id="startpage" data-role="page">
            <div data-role="header">
                <h1>SweTransit</h1>
            </div>
            <div data-role="content">
                <ul data-role="listview">
                    <li><a href="#locationpage">Stations nearby</a></li>
                    <li><a href="#editgeopage">Stations at specific location</a></li>
                </ul>
            </div>
        </div>
        <div id="locationpage" data-role="page" data-add-back-btn="true">
            <div data-role="header">
                <h1 id="locationtitle">Nearby stations</h1>
            </div>
            <div data-role="content">
                <ul id="stationlist" data-role="listview" onclick="onStationSelect(event);" ontouchstart="onStationSelect(event);">
                </ul>
            </div>
        </div>
        <div id="stationpage" data-role="page" data-add-back-btn="true">
            <div data-role="header">
                <h1 id="stationtitle"></h1>
            </div>
            <div data-role="content">
                <ul id="departurelist" data-role="listview">
                </ul>
            </div>
        </div>
        <div id="editgeopage" data-role="dialog" data-add-back-btn="true">
            <div data-role="header">
                <h1 id="editgeotitle"></h1>
            </div>
            <div data-role="content">
                <form onsubmit="editGeoSubmit(event);">
                    <label for="latitude">Latitude</label>
                    <input type="text" id="latitude">
                    <label for="longitude">Longitude</label>
                    <input type="text" id="longitude">
                    <button>Show stations nearby</button>
                    <button onclick="history.back();">Cancel</button>
                </form>
            </div>
        </div>
        <script src="/scripts/geolocation.js"></script>
        <script>
            var currentLocation = null;
            var stationListLocation = null;
            var stationList = null;

            // General functions - not dependant on this particular application and its views

            function getParentElement(element, tagName) {
                while (element!=null && element.tagName!=tagName)
                    element = element.parentNode;
                return element;
            }

            function parseQueryString() {
                var values = {};
                var queryParams = window.location.search.substring(1).split("&");
                for (var i = 0; i<queryParams.length; i++) {
                    var queryParam = queryParams[i].split("=");
                    values[queryParam[0]] = decodeURIComponent(queryParam[1]);
                }
                return values;
            }

            function directionAbbreviation(direction) {
                if (direction < 22.5)
                    return "N";
                else if (direction < 67.5)
                    return "NE";
                else if (direction < 112.5)
                    return "E";
                else if (direction < 157.5)
                    return "SE";
                else if (direction < 202.5)
                    return "S";
                else if (direction < 247.5)
                    return "SW";
                else if (direction < 292.5)
                    return "W";
                else if (direction < 337.5)
                    return "NW";
                else
                    return "N";
            }

            // Trafiklab functions - not dependant on the views, but on the Trafiklab API using
            // a server proxy script to handle the requests

            function requestStations(latitude, longitude, whenSuccess) {
                var query = "apiVersion=2.1&centerX=" + longitude + "&centerY=" + latitude +
                    "&radius=500&coordSys=WGS84";
                var localUrl = "/scripts/jlt.php";
                localUrl += "?api=resrobot";
                localUrl += "&method=StationsInZone";
                localUrl += "&query=" + encodeURIComponent(query);
                $.ajax({
                    url: localUrl,
                    dataType: "json",
                    success: whenSuccess,
                    error: function(http, errortype, errormsg) {
                        alert("Could not get station information!\n" + errortype + " " + errormsg);
                    }
                });
            }

            function requestDepartures(locationId, whenSuccess) {
                var query = "apiVersion=2.2&coordSys=RT90&locationId=" + locationId + "&timeSpan=120";
                var localUrl = "/scripts/jlt.php";
                localUrl += "?api=resrobotstops";
                localUrl += "&method=GetDepartures";
                localUrl += "&query=" + encodeURIComponent(query);
                $.ajax({
                    url: localUrl,
                    dataType: "json",
                    success: whenSuccess,
                    error: function(http, errortype, errormsg) {
                        alert("Could not get departure information!\n" + errortype + " " + errormsg);
                    }
                });
            }

            // Event functions - called when browser has completed some sort of event

            function gotDepartures(result) {
                var deps = result.getdeparturesresult.departuresegment;
                var html = "";
                for (var i = 0; i<deps.length; i++) {
                    html += "<li>";
                    html += deps[i].segmentid.carrier.number;
                    html += " to " + deps[i].direction;
                    html += " at " + deps[i].departure.datetime;
                    html += "</li>";
                }
                $("#departurelist").html(html);
            }

            function gotStations(result) {
                var stations = result.stationsinzoneresult.location;
                stationList = [];
                for (i = 0; i<stations.length; i++) {
                    var station = stations[i];
                    var lat = parseFloat(station['@y']);
                    var lng = parseFloat(station['@x']);
                    stationList.push({
                        id: station['@id'],
                        name: station.name,
                        latitude: lat,
                        longitude: lng,
                        distance: haversine(currentLocation.latitude, currentLocation.longitude, lat, lng),
                        direction: bearing(currentLocation.latitude, currentLocation.longitude, lat, lng)
                    });
                }
                stationList.sort(function(a, b) {
                    if (a.distance == b.distance)
                        return 0;
                    else if (a.distance < b.distance)
                        return -1;
                    else
                        return 1;
                });
                updateStationList();
            }

            function gotPosition(result) {
                setLocation(result.coords.latitude, result.coords.longitude);
            }

            function errorPosition(error) {
                alert("Could not retrieve your position (" + error.message + ")");
            }

            function onStationSelect(event) {
                var link = getParentElement(event.target, "A");
                if (link!=null && link.href.indexOf("#nearby")>=0) {
                    var nearbyIndex = parseInt(link.href.substring(link.href.indexOf("#nearby")+7));
                    var station = nearbyStations[nearbyIndex];
                    showStation(station);
                    event.preventDefault();
                }
            }

            // Controller functions - called by ourselves to perform a controlling function

            function showStation(station) {
                requestDepartures(station.id, gotDepartures);
                $("#stationtitle").text(station.name);
                $.mobile.changePage("#stationpage");
            }

            function updateStationList() {
                var html = "";
                for (var i = 0; i<stationList.length; i++) {
                    var station = stationList[i];
                    html += "<li>";
                    html += "<a href=\"#nearby" + i + "\">";
                    html += station.name + " (" + (Math.round(station.distance*100)*10) + "m " + directionAbbreviation(station.direction) + ")</a>";
                    html += "<a target=\"_blank\" href=\"http://maps.google.com/maps?q=" + station.latitude + "," + station.longitude + "\">Map</a>";
                    html += "</li>";
                }
                $("#stationlist").html(html);
            }
            
            function setLocation(lat, lng) {
                if (currentLocation!=null && (currentLocation.latitude!=lat || currentLocation.longitude!=lng)) {
                    $("#stationlist").html("");
                }
                currentLocation = { latitude: lat, longitude: lng };
                requestStations(lat, lng, gotStations);
            }

            function editGeoSubmit(event) {
                var lat = parseFloat($("#latitude").val());
                var lng = parseFloat($("#longitude").val());
                requestStations(lat, lng, gotStations);
                $.mobile.changePage("#nearbypage");
            }

            $(document).ready(function() {
                var query = parseQueryString();
                if (query.latitude && query.longitude) {
                    setLocation(parseFloat(query.latitude), parseFloat(query.longitude));
                }
                else {
                    navigator.geolocation.getCurrentPosition(gotPosition, errorPosition, { timeout: 15000 });
                }
            });

            $("#locationpage").bind("pageshow", function() {
                // Check if we should reload the contents of the station list
                if (currentLocation!=null && (stationLocation==null 
                    || stationLocation.latitude!=currentLocation.latitude
                    || stationLocation.longitude!=currentLocation.longitude)) {
                    $.mobile.loading("show");
                    requestStations(stationLocation.latitude, stationLocation.longitude, function(result) {
                        gotStations(result);
                        $.mobile.loading("hide");
                    });
                }
                else {
                    $("#stationlist").listview("refresh");
                }
            });
        </script>
    </body>
</html>

