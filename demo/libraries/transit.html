<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1"> 
        <title>Transit App</title>
        <link href="http://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
        <link href="http://fonts.googleapis.com/css?family=Ubuntu+Condensed" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css">
        <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
        <style>
        </style>
    </head>
    <body>
        <div id="startpage" data-role="page">
            <div data-role="header">
                <h1>Transit</h1>
            </div>
            <div data-role="content">
                <ul data-role="listview">
                    <li><a href="#nearbypage">Nearby stations</a></li>
                    <li><a href="#nearbypage">Stockholm</a></li>
                </ul>
            </div>
        </div>
        <div id="nearbypage" data-role="page" data-add-back-btn="true">
            <div data-role="header">
                <h1>Nearby stations</h1>
            </div>
            <div data-role="content">
                <ul id="nearby" data-role="listview" onclick="showNearby(event);" ontouchstart="showNearby(event);">
                </ul>
            </div>
        </div>
        <div id="stationpage" data-role="page" data-add-back-btn="true">
            <div data-role="header">
                <h1 id="stationtitle"></h1>
            </div>
            <div data-role="content">
                <ul id="departures" data-role="listview">
                </ul>
            </div>
        </div>
        <script src="/scripts/geolocation.js"></script>
        <script>
            var nearbyStations = [];
            var currentStationDepartures = {};
            var currentLocation = null;

            function getParentElement(element, tagName) {
                while (element!=null && element.tagName!=tagName)
                    element = element.parentNode;
                return element;
            }

            function requestStations(latitude, longitude, whenSuccess) {
                var query = "apiVersion=2.1&centerX=" + longitude + "&centerY=" + latitude +
                    "&radius=500&coordSys=WGS84";
                var localUrl = "/scripts/jlt.php";
                localUrl += "?api=resrobot";
                localUrl += "&method=StationsInZone";
                localUrl += "&query=" + encodeURIComponent(query);
                $.ajax({
                    url: localUrl,
                    dataType: "json",
                    success: whenSuccess,
                    error: function(http, errormsg) {
                        alert("Error! " + errormsg);
                    }
                });
            }

            function requestDepartures(locationId, whenSuccess) {
                var query = "apiVersion=2.2&coordSys=RT90&locationId=" + locationId + "&timeSpan=120";
                var localUrl = "/scripts/jlt.php";
                localUrl += "?api=resrobotstops";
                localUrl += "&method=GetDepartures";
                localUrl += "&query=" + encodeURIComponent(query);
                $.ajax({
                    url: localUrl,
                    dataType: "json",
                    success: whenSuccess,
                    error: function(http, errormsg) {
                        alert("Error! " + errormsg);
                    }
                });
            }

            function gotDepartures(result) {
                var deps = result.getdeparturesresult.departuresegment;
                var html = "";
                for (var i = 0; i<deps.length; i++) {
                    html += "<li>";
                    html += deps[i].segmentid.carrier.number;
                    html += " to " + deps[i].direction;
                    html += " at " + deps[i].departure.datetime;
                    html += "</li>";
                }
                $("#departures").html(html).listview("refresh");
            }

            function directionAbbreviation(direction) {
                if (direction < 22.5)
                    return "N";
                else if (direction < 67.5)
                    return "NE";
                else if (direction < 112.5)
                    return "E";
                else if (direction < 157.5)
                    return "SE";
                else if (direction < 202.5)
                    return "S";
                else if (direction < 247.5)
                    return "SW";
                else if (direction < 292.5)
                    return "W";
                else if (direction < 337.5)
                    return "NW";
                else
                    return "N";
            }

            function gotStations(result) {
                var stations = result.stationsinzoneresult.location;
                nearbyStations = [];
                for (i = 0; i<stations.length; i++) {
                    var station = stations[i];
                    var lat = parseFloat(station['@y']);
                    var lng = parseFloat(station['@x']);
                    nearbyStations.push({
                        id: station['@id'],
                        name: station.name,
                        latitude: lat,
                        longitude: lng,
                        distance: haversine(currentLocation.latitude, currentLocation.longitude, lat, lng),
                        direction: bearing(currentLocation.latitude, currentLocation.longitude, lat, lng)
                    });
                }
                nearbyStations.sort(function(a, b) {
                    if (a.distance == b.distance)
                        return 0;
                    else if (a.distance < b.distance)
                        return -1;
                    else
                        return 1;
                });
                var html = "";
                for (var i = 0; i<nearbyStations.length; i++) {
                    var station = nearbyStations[i];
                    html += "<li>";
                    html += "<a href=\"#nearby" + i + "\">";
                    html += station.name + " (" + (Math.round(station.distance*100)*10) + "m " + directionAbbreviation(station.direction) + ")</a>";
                    html += "<a target=\"_blank\" href=\"http://maps.google.com/maps?q=" + station.latitude + "," + station.longitude + "\">Map</a>";
                    html += "</li>";
                }
                $("#nearby").html(html).listview("refresh");
            }

            function gotPosition(result) {
                currentLocation = { latitude: result.coords.latitude, longitude: result.coords.longitude};
                requestStations(currentLocation.latitude, currentLocation.longitude, gotStations);
            }

            function errorPosition(error) {
                alert("Could not retrieve your position (" + error.message + ")");
            }
            
            function showNearby(event) {
                var link = getParentElement(event.target, "A");
                if (link!=null && link.href.indexOf("#nearby")>=0) {
                    var nearbyIndex = parseInt(link.href.substring(link.href.indexOf("#nearby")+7));
                    var location = nearbyStations[nearbyIndex];
                    requestDepartures(location.id, gotDepartures);
                    event.preventDefault();

                    $("#stationtitle").text(location.name);
                    $.mobile.changePage("#stationpage");
                }
            }

            function parseQueryString() {
                var values = {};
                var queryParams = window.location.search.substring(1).split("&");
                for (var i = 0; i<queryParams.length; i++) {
                    var queryParam = queryParams[i].split("=");
                    values[queryParam[0]] = decodeURIComponent(queryParam[1]);
                }
                return values;
            }

            var query = parseQueryString();
            if (query.latitude && query.longitude) {
                currentLocation = { latitude: parseFloat(query.latitude), longitude: parseFloat(query.longitude) };
                requestStations(currentLocation.latitude, currentLocation.longitude, gotStations);
            }
            else {
                navigator.geolocation.getCurrentPosition(gotPosition, errorPosition, { timeout: 15000 });
            }
        </script>
    </body>
</html>

